@page "/admin"
@using Microsoft.AspNetCore.Components.Authorization
@attribute [Authorize(Roles = "Admin")]
@layout AdminLayout
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthStateProvider
@inject UserService UserService

<h2>ðŸ“š Admin Dashboard</h2>

<AdminTopBar SelectedRole="@SelectedRole" OnSelectRole="SelectRoleFilter" />


<div class="admin-content mt-4">
    @if (SelectedRole == "" || SelectedRole == "Teacher")
    {
        <UserManagementView Students="Users" />
    }
    else if (SelectedRole == "Subjects")
    {
        <SubjectsView />
    }
    else if (SelectedRole == "Notifications")
    {
        <NotificationsView />
    }
    else
    {
        <p>Unknown view</p>
    }
</div>

@code {
    private string SelectedRole { get; set; } = string.Empty;
    private List<UserReadDto>? Users;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (!user.Identity?.IsAuthenticated ?? false)
        {
            NavigationManager.NavigateTo("/", true, replace: true);
            return;
        }

        SelectedRole = string.Empty;
        await LoadUsersAsync();
    }

    private void SelectRoleFilter(string role) => SelectedRole = (SelectedRole == role) ? string.Empty : role;

    private async Task LoadUsersAsync()
    {
        try
        {
            await Task.Delay(200);
            Users = await UserService.GetAllUsersAsync();
        }
        catch
        {
            Users = new List<UserReadDto>();
        }
    }
}
