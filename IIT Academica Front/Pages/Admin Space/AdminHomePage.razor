@page "/admin"
@using Microsoft.AspNetCore.Components.Authorization
@attribute [Authorize(Roles = "Admin")]
@layout AdminLayout
@using TableSkeleton
@using UserManagementView
@using SubjectsView
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthStateProvider
@inject UserService UserService

@* Capture the Layout context (required for Cascading Parameter pattern) *@
@if (AdminLayoutContext == null)
{
   <TableSkeleton />
}
else
{
    <h2>ðŸ“š Admin Dashboard</h2>

    @* NOTE: The buttons are now in the Layout. We only need the content here. *@
    <div class="admin-content mt-4">
        @if (SelectedRole == "" || SelectedRole == "Teacher")
        {
            <UserManagementView Students="Users" />
        }
        else if (SelectedRole == "Subjects")
        {
            <SubjectsView />
        }
        else if (SelectedRole == "Notifications")
        {
        }
        else
        {
            <p>Unknown view</p>
        }
    </div>
}


@code {
    // 1. Inject the Layout's class instance
    [CascadingParameter]
    public AdminLayout.AdminLayoutContext? AdminLayoutContext { get; set; }

    private string SelectedRole { get; set; } = string.Empty;
    private List<UserReadDto>? Users;


    // 2. Initialize the context in the Layout when ready
    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender && AdminLayoutContext != null)
        {
            AdminLayoutContext.SelectedRole = SelectedRole;
            AdminLayoutContext.RoleSelectedCallback = SelectRoleFilter;
        }
    }

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (!user.Identity?.IsAuthenticated ?? false)
        {
            NavigationManager.NavigateTo("/", true, replace: true);
            return;
        }

        SelectedRole = string.Empty;
        await LoadUsersAsync();
    }

    private void SelectRoleFilter(string role)
    {
        SelectedRole = (SelectedRole == role) ? string.Empty : role;
        // 3. Update the Layout's context whenever the role changes
        if (AdminLayoutContext != null)
        {
            AdminLayoutContext.SelectedRole = SelectedRole;
        }
        // Force the page content to re-render
        StateHasChanged(); 
    }

    private async Task LoadUsersAsync()
    {
        try
        {
            await Task.Delay(200);
            Users = await UserService.GetAllUsersAsync();
        }
        catch
        {
            Users = new List<UserReadDto>();
        }
    }
}