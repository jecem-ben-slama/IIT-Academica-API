@page "/admin"
@attribute [Authorize(Roles = "Admin")]
@layout AdminLayout 
@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager 
@inject AuthService AuthService
@inject UserService UserService

@* --- Content that will be rendered inside the @Body of AdminLayout --- *@


            
@*! Modify this to be synamic or delete*@
<h2>ðŸ“š Student List</h2>

@* === New Filtering and Search Controls === *@
    <div class="row justify-content-center mt-4"> @* Center the column containing the table *@

<div class="col-lg-10 col-xl-95"> @* Define the maximum width of the table (80-90% of container) *@

<div class="row mb-4">
    
    <div class="col-md-3">
        <label for="roleFilter" class="form-label">Filter by Role</label>
        <select id="roleFilter" class="form-select" @bind="SelectedRole">
            <option value="">All Roles</option>
            <option value="Admin">Admin</option>
            <option value="Student">Student</option>
            <option value="Teacher">Teacher</option>
           
            @* Add other roles as needed *@
        </select>
    </div>

    @* --- Search Bar Input --- *@
    <div class="col-md-6">
        <label for="searchQuery" class="form-label">Search by Name or Email</label>
        <input id="searchQuery" class="form-control" type="text" placeholder="Enter name or email..." @bind="SearchQuery" @bind:event="oninput" />
    </div>

    @* --- Refresh Button --- *@
    <div class="col-md-3 d-flex align-items-end">
        <button class="btn btn-outline-primary w-100" @onclick="LoadStudentsAsync">
             <i class="bi bi-arrow-clockwise"></i> Refresh List
        </button>
    </div>
</div>
</div>
</div>
<hr class="mt-1 mb-1" />

@* ========================================= *@
            
@if (isLoading)
{
     <div class="row justify-content-center mt-4"> @* Center the column containing the table *@

<div class="col-lg-10 col-xl-9">
    <div class="card shadow-sm mt-3">
        <div class="card-body">
            <h5 class="card-title skeleton-line short"></h5>
            
            <div class="table-responsive skeleton-table mt-4">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @for (int i = 0; i < 5; i++)
                        {
                            <tr>
                                <td><div class="skeleton-line tiny"></div></td>
                                <td><div class="skeleton-line medium"></div></td>
                                <td><div class="skeleton-line long"></div></td>
                                <td><div class="skeleton-line short"></div></td>
                                <td><div class="skeleton-line tiny"></div></td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div> </div>
    </div>
    
    
}

else if (errorMessage != null)
{
    @* ... Error Alert ... *@
}
else if (FilteredStudents == null || !FilteredStudents.Any())
{
    <div class="alert alert-info mt-3">
        No student records found based on the current filters.
    </div>
}
else
{
    <div class="row justify-content-center mt-4"> @* Center the column containing the table *@
        <div class="col-lg-10 col-xl-95"> @* Define the maximum width of the table (80-90% of container) *@
            <div class="table-responsive">
                <table class="table table-striped table-hover shadow-sm rounded">
                    <thead class="bg-primary text-white">
                        <tr>
                            <th>ID</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var student in FilteredStudents)
                        {
                            <tr>
                                <td>@student.Id</td>
                                <td>@student.Name @student.LastName</td>
                                <td>@student.Email</td>
                                <td>@student.Role</td>
                                <td>
                                    <button class="btn btn-sm btn-info me-2">View</button>
                                    <button class="btn btn-sm btn-warning">Edit</button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
}

@code {   
    private List<UserReadDto>? students; 
    private string? errorMessage;
    private bool isLoading = true;
    private const string ScrollKey = "AdminScrollPosition"; // Unique key for storage

    private string SearchQuery { get; set; } = string.Empty;
    private string SelectedRole { get; set; } = string.Empty;

   private IEnumerable<UserReadDto> FilteredStudents => students?
    .Where(s => 
        // 1. Role Filter
        (string.IsNullOrEmpty(SelectedRole) || s.Role.Equals(SelectedRole, StringComparison.OrdinalIgnoreCase)) &&
        // 2. Search Filter (Updated to check Full Name)
        (string.IsNullOrEmpty(SearchQuery) || 
         // Create a combined string for name searching:
         $"{s.Name} {s.LastName}".Contains(SearchQuery, StringComparison.OrdinalIgnoreCase) ||
         s.Email.Contains(SearchQuery, StringComparison.OrdinalIgnoreCase))
    ) ?? Enumerable.Empty<UserReadDto>();

// Note: I've also switched to OrdinalIgnoreCase for better user experience.

    protected override async Task OnInitializedAsync()
    {
        await LoadStudentsAsync();
    }
    
    
    private async Task LoadStudentsAsync()
    {
        isLoading = true;
        errorMessage = null;

        try
        {
            // add awit time
             await Task.Delay(1000); // Simulate loading delay
            students=await UserService.GetAllUsersAsync();
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to fetch users list: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }
}