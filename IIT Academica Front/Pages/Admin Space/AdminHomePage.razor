@page "/admin"
@layout AdminLayout
@attribute [Authorize(Roles = "Admin")]

@using Microsoft.AspNetCore.Components.Authorization
@inject AuthenticationStateProvider AuthStateProvider

@using System.Security.Claims
@using TableSkeleton
@using UserManagementView
@using SubjectsView
@using NotificationsView

@inject NavigationManager NavigationManager
@inject UserService UserService

@* ------------------- MAIN CONTENT CONTAINER (ID ADDED) ------------------- *@
<div id="admin-dashboard-content" class="admin-content mt-4">
    @if (SelectedRole == "" || SelectedRole == "Teacher")
    {
        @* ------------------- USER MANAGEMENT VIEW CONTAINER (ID ADDED) ------------------- *@
        <div id="view-user-management">
            <UserManagementView Students="Users" />
        </div>
    }
    else if (SelectedRole == "Subjects")
    {
        @* ------------------- SUBJECTS VIEW CONTAINER (ID ADDED) ------------------- *@
        <div id="view-subjects">
            <SubjectsView />
        </div>
    }
    else if (SelectedRole == "Notifications")
    {
        @* ------------------- NOTIFICATIONS VIEW CONTAINER (ID ADDED) ------------------- *@
        <div id="view-notifications">
            <NotificationsView />
        </div>
    }
    else
    {
        <p id="view-unknown">Unknown view</p>
    }
</div>

@code {
    [CascadingParameter]
    public AdminLayout.AdminLayoutContext? AdminLayoutContext { get; set; }

    private string SelectedRole { get; set; } = string.Empty;
    private List<UserReadDto>? Users;

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender && AdminLayoutContext != null)
        {
            AdminLayoutContext.SelectedRole = SelectedRole;
            AdminLayoutContext.RoleSelectedCallback = SelectRoleFilter;
        }
    }

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (!user.Identity?.IsAuthenticated ?? false)
        {
            NavigationManager.NavigateTo("/", true, replace: true);
            return;
        }

        if (!user.IsInRole("Admin"))
        {
            NavigationManager.NavigateTo("/forbidden", true, replace: true);
            return;
        }

        SelectedRole = string.Empty;
        await LoadUsersAsync();
    }

    private void SelectRoleFilter(string role)
    {
        // Toggle logic: If the same role is clicked, clear the filter. Otherwise, set the new role.
        SelectedRole = (SelectedRole == role) ? string.Empty : role;
        if (AdminLayoutContext != null)
            AdminLayoutContext.SelectedRole = SelectedRole;
        StateHasChanged();
    }

    private async Task LoadUsersAsync()
    {
        try
        {
            await Task.Delay(200);
            Users = await UserService.GetAllUsersAsync();
        }
        catch
        {
            Users = new List<UserReadDto>();
        }
    }
}