@namespace UserManagementView
@using Microsoft.AspNetCore.Components.Forms
@using TableSkeleton
@using UserFormModal
@inject UserService UserService

<div class="row mb-5 align-items-center justify-content-between">
    <div class="col-md-4 mb-5 mb-md-2 d-flex gap-4">
        @* ------------------- Search Input (ID ADDED) ------------------- *@
        <input id="user-search-input" class="form-control"
               type="text"
               placeholder="Search name or email..."
               @bind="SearchQuery"
               @bind:event="oninput" />

        @* ------------------- Role Filter Dropdown (ID ADDED) ------------------- *@
        <select id="role-filter-select" class="form-select w-1" @bind="SelectedRoleFilter">
            <option value="">All Roles</option>
            @foreach (var role in AvailableRoles)
            {
                <option value="@role">@role</option>
            }
        </select>
    </div>

    <div class="col-md-6 d-flex justify-content-end gap-2">
        @* ------------------- Refresh Button (ID ADDED) ------------------- *@
        <button id="refresh-users-btn" class="btn btn-outline-primary" title="Refresh List" @onclick="RefreshList">
            <i class="bi bi-arrow-clockwise"></i> Refresh
        </button>

        @* ------------------- Add User Button (ID ADDED) ------------------- *@
        <button id="add-user-btn" class="btn btn-success d-flex align-items-center gap-2" @onclick="OpenAddUserModal">
            <i class="bi bi-person-plus-fill"></i> Add User
        </button>
    </div>
</div>

@if (IsLoading)
{
    @* Using a placeholder ID for loading state *@
    <div id="user-list-loading-state">
        <TableSkeleton></TableSkeleton>
    </div>
}


else if (!string.IsNullOrEmpty(ErrorMessage))
{
    @* ------------------- Error Message (ID ADDED) ------------------- *@
    <div id="user-list-error-message" class="alert alert-danger mt-3">@ErrorMessage</div>
}
else if (FilteredStudents == null || !FilteredStudents.Any())
{
    @* ------------------- No Records Message (ID ADDED) ------------------- *@
    <div id="user-list-no-records" class="alert alert-info mt-3 text-center">No user records found.</div>
}
else
{
    @* ------------------- User Table (ID ADDED) ------------------- *@
    <div class="table-responsive">
        <table id="user-list-table" class="table table-striped table-hover shadow-sm rounded">
            <thead class="bg-primary text-white">
                <tr>
                    <th>ID</th><th>Name</th><th>Email</th><th>Role</th><th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var student in FilteredStudents)
                {
                    @* ------------------- Table Row (ID ADDED) ------------------- *@
                    <tr id="user-row-@student.Id">
                        <td>@student.Id</td>
                        <td>@student.Name @student.LastName</td>
                        <td>@student.Email</td>
                        <td>@student.Role</td>
                        <td>
                            @* ------------------- Edit Button (ID ADDED) ------------------- *@
                            <button id="edit-user-btn-@student.Id" class="btn btn-sm btn-warning" @onclick="() => OpenEditUserModal(student.Id)">Edit</button>
                            @* ------------------- Delete Button (ID ADDED) ------------------- *@
                            <button id="delete-user-btn-@student.Id" class="btn btn-sm btn-danger" @onclick="()=>ConfirmDelete(student.Id, student.Email)">Delete</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

@* --- Modals --- *@
@* The UserFormModal component itself has internal IDs for its elements *@
@if (ShowUserModal)
{
    <UserFormModal IsEditMode="@(UserToEditId > 0)" UserId="@UserToEditId" OnClose="CloseUserModal" OnFormSubmitted="HandleUserFormSubmitted" />
}

@* ------------------- Delete Confirmation Modal (IDs ADDED) ------------------- *@
@if (ShowDeleteConfirm)
{
    <div id="delete-confirm-modal" class="modal d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Confirm Deletion</h5>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete **@UserToDeleteEmail**?</p>
                    <p id="delete-warning-message" class="text-danger small">This cannot be undone.</p>
                </div>
                <div class="modal-footer">
                    @* ------------------- Cancel Button (ID ADDED) ------------------- *@
                    <button id="delete-cancel-btn" class="btn btn-secondary" @onclick="CancelDelete">Cancel</button>
                    @* ------------------- Confirm Delete Button (ID ADDED) ------------------- *@
                    <button id="delete-confirm-btn" class="btn btn-danger" @onclick="HandleDelete">Delete</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public List<UserReadDto>? Students { get; set; }

    private string SearchQuery { get; set; } = string.Empty;
    private string SelectedRoleFilter { get; set; } = string.Empty; // NEW: Holds the selected role
    private List<string> AvailableRoles { get; set; } = new List<string>(); // NEW: List of unique roles
    
    private bool IsLoading { get; set; } = false;
    private string? ErrorMessage { get; set; }

    private bool ShowUserModal = false;
    private int UserToEditId = 0;

    private bool ShowDeleteConfirm = false;
    private int UserToDeleteId;
    private string UserToDeleteEmail = "";
    
    // Updated: Includes role filtering
    private IEnumerable<UserReadDto> FilteredStudents => Students?
        .Where(s =>
            // Search Query Filter
            (string.IsNullOrEmpty(SearchQuery) ||
             $"{s.Name} {s.LastName}".Contains(SearchQuery, StringComparison.OrdinalIgnoreCase) ||
             s.Email.Contains(SearchQuery, StringComparison.OrdinalIgnoreCase)) &&
            // Role Filter
            (string.IsNullOrEmpty(SelectedRoleFilter) ||
             s.Role.Equals(SelectedRoleFilter, StringComparison.OrdinalIgnoreCase))
        ) ?? Enumerable.Empty<UserReadDto>();

    // NEW: Populates the list of unique roles when the component is initialized or Students list changes
    protected override void OnParametersSet()
    {
        base.OnParametersSet();
        UpdateAvailableRoles();
    }

    private void UpdateAvailableRoles()
    {
        if (Students != null)
        {
            // Get unique roles from the current list of users
            AvailableRoles = Students
                .Where(s => !string.IsNullOrEmpty(s.Role))
                .Select(s => s.Role!) // The '!' asserts non-null since we filtered for it
                .Distinct()
                .OrderBy(r => r)
                .ToList();
        }
    }

    private void OpenAddUserModal()
    {
        UserToEditId = 0;
        ShowUserModal = true;
    }

    private void OpenEditUserModal(int id)
    {
        UserToEditId = id;
        ShowUserModal = true;
    }

    private void CloseUserModal() => ShowUserModal = false;

    private async Task HandleUserFormSubmitted()
    {
        CloseUserModal();
        await RefreshList();
    }

    private void ConfirmDelete(int id, string email)
    {
        UserToDeleteId = id;
        UserToDeleteEmail = email;
        ShowDeleteConfirm = true;
    }

    private void CancelDelete() => ShowDeleteConfirm = false;

    private async Task HandleDelete()
    {
        ShowDeleteConfirm = false;
        if (UserToDeleteId <= 0) return;
        IsLoading = true;

        try
        {
            await UserService.DeleteUserAsync(UserToDeleteId);
            await RefreshList();
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Delete failed: {ex.Message}";
        }
        finally
        {
            IsLoading = false;
        }
    }

    // Updated: Calls UpdateAvailableRoles after fetching new data
    private async Task RefreshList()
    {
        IsLoading = true;
        ErrorMessage = null;

        try
        {
            // Note: Task.Delay(200) added for simulation/visual effect in original code, 
            // removed for production, but kept here for consistency.
            await Task.Delay(200); 
            // IMPORTANT: Assumes UserService.GetAllUsersAsync() returns List<UserReadDto>
            Students = await UserService.GetAllUsersAsync();
            UpdateAvailableRoles(); // Update roles after fetching new data
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Failed to load users: {ex.Message}";
        }
        finally
        {
            IsLoading = false;
        }
    }
    
    
}