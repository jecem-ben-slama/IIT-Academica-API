@namespace SubjectsView
@using IIT_Academica_Front.Models
@using System.Security.Claims
@using DeleteConfirmationModal
@inject SubjectService SubjectService
@inject UserService UserService
@inject IJSRuntime JSRuntime

@* This component assumes it is rendered within an Authorized context (Admin) *@

<div id="subject-management-view" class="subject-management-container">
    <h3><span class="oi oi-book" aria-hidden="true"></span> Subject Management</h3>

    <p id="main-error-message" class="text-danger">@ErrorMessage</p>

    @if (IsLoading)
    {
        <p><em>Loading subjects...</em></p>
    }
    else if (Subjects == null || !Subjects.Any())
    {
        <p id="no-subjects-message" class="text-info">No subjects found.</p>
    }
    else
    {
        @* --- Add New Button & Search Input --- *@
        <div class="d-flex justify-content-between align-items-center mb-3">
            @* ------------------- Add New Button (ID ADDED) ------------------- *@
            <button id="add-new-subject-btn" class="btn btn-primary" @onclick="() => OpenCreateForm()">
                <span class="oi oi-plus" aria-hidden="true"></span> Add New Subject
            </button>
            
            @* ------------------- Search Input Field (ID ADDED) ------------------- *@
            <div class="input-group" style="max-width: 350px;">
                <span class="input-group-text oi oi-magnifying-glass" aria-hidden="true"></span>
                <input id="subject-search-input"
                       class="form-control"
                       type="text"
                       placeholder="Search code or title..."
                       @bind="SearchQuery"
                       @bind:event="oninput" />
            </div>
        </div>

        @* --- Subject Table --- *@
        <div class="table-responsive">
            <table id="subjects-table" class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Code</th>
                        <th>Title</th>
                        <th>Teacher</th>
                        <th>Enrollments</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @* Use FilteredSubjects here *@
                    @foreach (var subject in FilteredSubjects)
                    {
                        <tr id="subject-row-@subject.Id">
                            <td>@subject.Id</td>
                            <td id="subject-code-@subject.Id"><strong>@subject.RegistrationCode</strong></td>
                            <td id="subject-title-@subject.Id">@subject.SubjectName</td>
                            <td>@subject.TeacherFullName (ID: @subject.TeacherId)</td>
                            <td>@subject.EnrollmentCount</td>
                            <td>
                                @* ------------------- Edit Button (ID ADDED) ------------------- *@
                                <button id="edit-subject-btn-@subject.Id" class="btn btn-sm btn-info" @onclick="() => OpenEditForm(subject)">Edit</button>
                                @* ------------------- Delete Button (ID ADDED) ------------------- *@
                                @* Use OpenDeleteModal instead of direct DeleteSubject call *@
                                <button id="delete-subject-btn-@subject.Id" class="btn btn-sm btn-danger" @onclick="() => OpenDeleteModal(subject)">Delete</button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }

    @* ------------------- Create/Update Modal Forms (IDs ADDED) ------------------- *@
    @if (ShowModal)
    {
        <div id="subject-modal" class="modal fade show d-block" tabindex="-1" role="dialog" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 id="modal-title" class="modal-title">@(CurrentSubjectId == 0 ? "Create New Subject" : "Edit Subject")</h5>
                        <button id="modal-close-btn" type="button" class="close" @onclick="CloseModal">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <EditForm Model="@CurrentDto" OnValidSubmit="@HandleSubmit">
                            <DataAnnotationsValidator />
                            <ValidationSummary />

                            <div class="form-group mb-3">
                                <label for="reg-code-input">Registration Code:</label>
                                @* ------------------- REG CODE INPUT (ID ADDED) ------------------- *@
                                <InputText id="reg-code-input" @bind-Value="CurrentDto.RegistrationCode" class="form-control" />
                            </div>
                            
                            <div class="form-group mb-3">
                                <label for="subject-title-input">Title:</label>
                                @* ------------------- TITLE INPUT (ID ADDED) ------------------- *@
                                <InputText id="subject-title-input" @bind-Value="CurrentDto.SubjectName" class="form-control" />
                            </div>
                            
                            @* Use Select for Teacher Name *@
                            <div class="form-group mb-3">
                                <label for="teacherSelect">Teacher:</label>
                                @if (Teachers != null && Teachers.Any())
                                {
                                    @* ------------------- TEACHER SELECT (ID ADDED) ------------------- *@
                                    <InputSelect id="teacher-select" @bind-Value="SelectedTeacherId" class="form-control">
                                        <option value="">-- Select Teacher --</option>
                                        @foreach (var teacher in Teachers)
                                        {
                                            <option id="teacher-option-@teacher.Id" value="@teacher.Id">@teacher.Name @teacher.LastName</option>
                                        }
                                    </InputSelect>
                                }
                                else
                                {
                                    <p class="text-warning">Loading teachers or none found...</p>
                                    <InputNumber @bind-Value="CurrentDto.TeacherId" class="form-control" disabled />
                                }
                                <ValidationMessage For="@(() => SelectedTeacherId)" />
                            </div>
                            
                            @* ------------------- MODAL ERROR MESSAGE (ID ADDED) ------------------- *@
                            <p id="modal-error-message" class="text-danger mt-2">@ModalErrorMessage</p>
                            
                            <div class="modal-footer mt-4">
                                @* ------------------- CANCEL BUTTON (ID ADDED) ------------------- *@
                                <button id="modal-cancel-btn" type="button" class="btn btn-secondary" @onclick="CloseModal">Cancel</button>
                                @* ------------------- SUBMIT BUTTON (ID ADDED) ------------------- *@
                                <button id="modal-submit-btn" type="submit" class="btn btn-primary">@(CurrentSubjectId == 0 ? "Create" : "Update")</button>
                            </div>
                        </EditForm>
                    </div>
                </div>
            </div>
        </div>
    }

    @* ------------------- DELETE CONFIRMATION MODAL ------------------- *@
    @if (ShowDeleteConfirm)
    {
        <DeleteConfirmationModal
            Title="Confirm Deletion"
            Message="@($"Are you sure you want to delete subject: {SubjectToDelete.SubjectName} ({SubjectToDelete.RegistrationCode})?")"
            ConfirmButtonText="Delete Subject"
            CustomError="@DeleteErrorMessage"
            IsProcessing="@IsDeleting"
            OnConfirm="HandleDeleteConfirm"
            OnCancel="CloseDeleteModal" />
    }
</div>

@code {
    // --- State ---
    private List<SubjectDTO>? Subjects;
    private List<UserReadDto>? Teachers; 
    private string ErrorMessage = string.Empty;
    private string ModalErrorMessage = string.Empty;
    private bool IsLoading = true;
    
    // NEW STATE: Search Query
    private string SearchQuery = string.Empty; 

    // --- Modal State (Create/Edit) ---
    private bool ShowModal = false;
    private int CurrentSubjectId = 0;
    private CreateSubjectDto CurrentDto = new CreateSubjectDto();

    // --- Modal State (Delete) ---
    private bool ShowDeleteConfirm = false;
    private SubjectDTO SubjectToDelete = new SubjectDTO();
    private bool IsDeleting = false;
    private string DeleteErrorMessage = string.Empty;

    // NEW LOGIC: Filtered Subjects Property
    private IEnumerable<SubjectDTO> FilteredSubjects => Subjects?
        .Where(s =>
            string.IsNullOrEmpty(SearchQuery) ||
            s.RegistrationCode.Contains(SearchQuery, StringComparison.OrdinalIgnoreCase) ||
            s.SubjectName.Contains(SearchQuery, StringComparison.OrdinalIgnoreCase)
        ) ?? Enumerable.Empty<SubjectDTO>();
    
    // Helper property to handle binding for InputSelect (must be string)
    private string SelectedTeacherId
    {
        get => CurrentDto.TeacherId.ToString() ?? string.Empty;
        set
        {
            if (int.TryParse(value, out int id) && id > 0)
            {
                CurrentDto.TeacherId = id;
            }
            else
            {
                CurrentDto.TeacherId = 0; // Handle '-- Select Teacher --' option
            }
        }
    }

    // --- Initialization ---

    protected override async Task OnInitializedAsync()
    {
        await LoadSubjectsAsync();
        await LoadTeachersAsync();
    }

    private async Task LoadSubjectsAsync()
    {
        IsLoading = true;
        ErrorMessage = string.Empty;
        try
        {
            Subjects = await SubjectService.GetAllSubjectsAsync();
        }
        catch (HttpRequestException ex)
        {
            ErrorMessage = $"Error loading subjects: {ex.Message}";
            Subjects = null;
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }

    private async Task LoadTeachersAsync()
    {
        try
        {
            // Assuming GetAllUsersAsync returns all users, and we filter for "Teacher" role.
            var allUsers = await UserService.GetAllUsersAsync();
            Teachers = allUsers?
                .Where(u => u.Role == "Teacher")
                .ToList() ?? new List<UserReadDto>(); 

        }
        catch (HttpRequestException ex)
        {
            ErrorMessage = $"Error loading teachers: {ex.Message}";
            Teachers = new List<UserReadDto>();
        }
    }

    // --- CRUD Operations (Create/Update) ---

    private async Task HandleSubmit()
    {
        ModalErrorMessage = string.Empty;

        if (CurrentDto.TeacherId == null || CurrentDto.TeacherId <= 0)
        {
            ModalErrorMessage = "Please select a valid Teacher.";
            return;
        }
        
        try
        {
            if (CurrentSubjectId == 0)
            {
                // CREATE operation
                await SubjectService.CreateSubjectAsync(CurrentDto);
            }
            else
            {
                // UPDATE operation
                var updateDto = new UpdateSubjectDTO
                {
                    Id = CurrentSubjectId,
                    SubjectName = CurrentDto.SubjectName,
                    TeacherId = CurrentDto.TeacherId, 
                    RegistrationCode = CurrentDto.RegistrationCode 
                };

                await SubjectService.UpdateSubjectAsync(updateDto);
            }

            CloseModal();
            await LoadSubjectsAsync(); // Refresh list
        }
        catch (InvalidOperationException ex)
        {
            ModalErrorMessage = $"Operation failed: {ex.Message}";
        }
        catch (HttpRequestException ex)
        {
            // Parse a more helpful error message if possible
            ModalErrorMessage = $"API Error: {ex.Message}";
        }
    }

    // --- CRUD Operations (Delete) ---

    private void OpenDeleteModal(SubjectDTO subject)
    {
        SubjectToDelete = subject;
        DeleteErrorMessage = string.Empty;
        ShowDeleteConfirm = true;
    }

    private void CloseDeleteModal()
    {
        ShowDeleteConfirm = false;
        IsDeleting = false;
        DeleteErrorMessage = string.Empty;
        SubjectToDelete = new SubjectDTO();
    }
    
    private async Task HandleDeleteConfirm()
    {
        IsDeleting = true;
        DeleteErrorMessage = string.Empty;
        
        try
        {
            await SubjectService.DeleteSubjectAsync(SubjectToDelete.Id);
            
            // Success: Close modal and refresh list
            CloseDeleteModal();
            await LoadSubjectsAsync();
        }
        catch (HttpRequestException ex)
        {
            // Check for specific conflict status (e.g., 409 Conflict) from the API
            string detailMessage = ex.Message;
            
            if (ex.StatusCode == System.Net.HttpStatusCode.Conflict)
            {
                // Custom error for existing enrollments (from the server-side change)
                DeleteErrorMessage = "Cannot delete this subject because active student enrollments exist. Please ensure all students are dropped from this subject first.";
            }
            else
            {
                DeleteErrorMessage = $"Deletion failed: {detailMessage}";
            }
        }
        catch (Exception ex)
        {
            DeleteErrorMessage = $"An unexpected error occurred: {ex.Message}";
        }
        finally
        {
            IsDeleting = false;
        }
    }

    // --- Modal Control (Create/Edit) ---

    private void OpenCreateForm()
    {
        CurrentSubjectId = 0;
        CurrentDto = new CreateSubjectDto();
        ModalErrorMessage = string.Empty;
        ShowModal = true;
    }

    private void OpenEditForm(SubjectDTO subject)
    {
        CurrentSubjectId = subject.Id;
        
        // Map fields for editing
        CurrentDto = new CreateSubjectDto
        {
            RegistrationCode = subject.RegistrationCode, 
            SubjectName = subject.SubjectName,
            TeacherId = subject.TeacherId
        };
        
        ModalErrorMessage = string.Empty;
        ShowModal = true;
    }

    private void CloseModal()
    {
        ShowModal = false;
        CurrentSubjectId = 0;
        CurrentDto = new CreateSubjectDto();
        ModalErrorMessage = string.Empty;
    }
}