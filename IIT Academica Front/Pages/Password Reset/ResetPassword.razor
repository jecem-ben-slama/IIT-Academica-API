@page "/auth/reset-password"
@using IIT_Academica_DTOs
@using IIT_Academica_Front.Services
@inject AuthService AuthService
@inject NavigationManager Navigation

<h3 id="reset-password-title">Reset Your Password ðŸ”’</h3>
<p class="text-muted">Enter and confirm your new password below.</p>

<hr />

@if (TokenReady)
{
    @if (!string.IsNullOrEmpty(Message))
    {
        @* ------------------- Alert Message (ID ADDED) ------------------- *@
        <div id="reset-password-alert" class="alert @AlertClass" role="alert">
            @Message
        </div>
    }

    @* ------------------- Edit Form (ID ADDED) ------------------- *@
    <EditForm id="reset-password-form" Model="@Model" OnValidSubmit="@HandleResetPassword">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="form-group mb-3">
            <label for="newPassword-input">New Password</label>
            @* --- NEW PASSWORD FIELD WITH TOGGLE --- *@
            <div class="password-wrapper"> 
                <InputText id="newPassword-input" 
                           type="@(showNewPassword ? "text" : "password")" 
                           class="form-control" 
                           @bind-Value="Model.NewPassword" />
                @* ------------------- New Password Toggle Button (ID ADDED) ------------------- *@
                <button id="toggle-new-password-btn" type="button" class="toggle-password btn btn-sm" @onclick="ToggleNewPasswordVisibility">
                    <i class="bi @(showNewPassword ? "bi-eye-slash" : "bi-eye")"></i>
                </button>
            </div>
            @* ------------------- New Password Validation (ID ADDED) ------------------- *@
            <ValidationMessage id="newPassword-validation" For="@(() => Model.NewPassword)" />
        </div>

        <div class="form-group mb-3">
            <label for="confirmPassword-input">Confirm Password</label>
            @* --- CONFIRM PASSWORD FIELD WITH TOGGLE --- *@
            <div class="password-wrapper"> 
                <InputText id="confirmPassword-input" 
                           type="@(showConfirmPassword ? "text" : "password")" 
                           class="form-control" 
                           @bind-Value="Model.ConfirmPassword" />
                @* ------------------- Confirm Password Toggle Button (ID ADDED) ------------------- *@
                <button id="toggle-confirm-password-btn" type="button" class="toggle-password btn btn-sm" @onclick="ToggleConfirmPasswordVisibility">
                    <i class="bi @(showConfirmPassword ? "bi-eye-slash" : "bi-eye")"></i>
                </button>
            </div>
            @* ------------------- Confirm Password Validation (ID ADDED) ------------------- *@
            <ValidationMessage id="confirmPassword-validation" For="@(() => Model.ConfirmPassword)" />
        </div>

        @* ------------------- Submit Button (ID ADDED) ------------------- *@
        <button id="change-password-btn" type="submit" class="btn btn-primary" disabled="@IsLoading">
            @if (IsLoading)
            {
                @* ------------------- Loading Spinner (ID ADDED) ------------------- *@
                <span id="submit-loading-spinner" class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true">Processing...</span>
                
            }
            else
            {
                <span>Change Password</span>
            }
        </button>
    </EditForm>
}
else
{
    @* ------------------- Token Error Message (ID ADDED) ------------------- *@
    <div id="token-error-message" class="alert alert-danger">
        Error: Reset token or email not found in the URL. Please ensure you clicked the full link from your email.
    </div>
}

@code {
    // These parameters capture the values from the URL query string
    [SupplyParameterFromQuery(Name = "email")]
    public string EmailFromUrl { get; set; } = string.Empty;

    [SupplyParameterFromQuery(Name = "token")]
    public string TokenFromUrl { get; set; } = string.Empty;

    private ResetPasswordDto Model = new ResetPasswordDto();
    private bool TokenReady => !string.IsNullOrEmpty(EmailFromUrl) && !string.IsNullOrEmpty(TokenFromUrl);
    private string Message = string.Empty;
    private string AlertClass = "alert-info";
    private bool IsLoading = false;

    // --- NEW PASSWORD VISIBILITY LOGIC ---
    private bool showNewPassword = false;
    private bool showConfirmPassword = false;

    private void ToggleNewPasswordVisibility() => showNewPassword = !showNewPassword;
    private void ToggleConfirmPasswordVisibility() => showConfirmPassword = !showConfirmPassword;
    // -------------------------------------

    // This method runs after parameters (EmailFromUrl, TokenFromUrl) are set
    protected override void OnInitialized()
    {
        if (TokenReady)
        {
            // Pre-fill the model with hidden values from the URL
            Model.Email = EmailFromUrl;
            Model.Token = TokenFromUrl;
        }
    }

    private async Task HandleResetPassword()
    {
        if (!TokenReady)
        {
            Message = "Error: Invalid reset link parameters.";
            AlertClass = "alert-danger";
            return;
        }

        IsLoading = true;
        Message = string.Empty;

        // 1. Call the service to hit the API
        var result = await AuthService.ResetPassword(Model);

        // 2. Handle the response
        if (result.IsSuccess)
        {
            Message = result.Message;
            AlertClass = "alert-success";
            
            // Redirect the user to the login page after a successful reset
            await Task.Delay(3000);
            Navigation.NavigateTo("/auth/login");
        }
        else
        {
            // Ensure you display ALL errors, not just the message
            Message = result.Message + " " + string.Join(" ", result.Errors ?? new List<string>());
            AlertClass = "alert-danger";
        }

        IsLoading = false;
    }
}