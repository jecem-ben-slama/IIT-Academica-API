@page "/student"
@layout StudentLayout
@using IIT_Academica.Enums
@using StudentLayout
@using NotificationsFeed
@attribute [Authorize(Roles = "Student")]
@using Microsoft.AspNetCore.Components.Authorization
@inject NavigationManager NavigationManager

@inject AuthenticationStateProvider AuthStateProvider
@inject EnrollmentService EnrollmentService
@inject SubjectService SubjectService
@inject NotificationService NotificationService // <-- NEW
@inject IJSRuntime JSRuntime

@* --- Render Section: Conditional Content --- *@

<div class="container-fluid p-4">
    
    @* ------------------- General Error State (ID ADDED) ------------------- *@
    @if (LoadingError != null)
    {
        <div id="dashboard-general-error" class="alert alert-danger">
            <h5 class="alert-heading">Data Loading Error</h5>
            <p>Could not fetch data: @LoadingError</p>
            @* ------------------- Retry Button (ID ADDED) ------------------- *@
            <button id="dashboard-retry-btn" class="btn btn-sm btn-outline-danger mt-2" @onclick="LoadDataAsync">Retry Loading</button>
        </div>
    }

    @* --- Conditional Rendering based on the selected view state --- *@
    
    @if (SelectedView == ViewState.NotificationsFeed) // <-- NEW: Renders the notification feed
    {
        @* ------------------- Notifications View (ID ADDED) ------------------- *@
        <div id="notifications-view">
            <NotificationsFeed
                Notifications="@Notifications"
                IsLoading="@IsLoadingNotifications"
                LoadingError="@LoadingError"
                OnRetryLoading="LoadNotificationsAsync" />
        </div>
    }
    else if (SelectedView == ViewState.MyCourses)
    {
        @* ------------------- My Courses View (ID ADDED) ------------------- *@
        <div id="my-courses-view">
            <MyCourses 
                EnrolledCourses="@EnrolledCourses" 
                IsLoadingMyCourses="@IsLoadingMyCourses"
                OnDropCourse="ConfirmDropCourse" />
        </div>
    }
    else if (SelectedView == ViewState.AllCourses)
    {
        @* ------------------- All Courses View (ID ADDED) ------------------- *@
        <div id="all-courses-view">
            <AllCourses 
                AvailableSubjects="@AvailableSubjects"
                EnrolledCourses="@EnrolledCourses" 
                IsLoadingAllSubjects="@IsLoadingAllSubjects"
                OnEnrollmentRequested="ShowEnrollmentModal" />
        </div>
    }
</div>

@* ---------------- Modal: Enrollment Confirmation ---------------- *@
@* ------------------- Modal Container (ID ADDED) ------------------- *@
<div id="enrollment-modal" class="modal @(ShowEnrollModal ? "show d-block" : "")" tabindex="-1" 
     style="@(ShowEnrollModal ? "background-color: rgba(0,0,0,.5);" : "")">
    <div class="modal-dialog">
        <div class="modal-content">
            
            <EditForm Model="@EnrollmentDto" OnValidSubmit="HandleEnrollment">
                <DataAnnotationsValidator />
                
                <div class="modal-header bg-primary text-white">
                    <h5 id="enroll-modal-title" class="modal-title">Enroll in @(CurrentSubject?.SubjectName)</h5>
                    @* ------------------- Close Button (ID ADDED) ------------------- *@
                    <button id="enroll-modal-close-btn" type="button" class="btn-close btn-close-white" @onclick="HideEnrollmentModal"></button>
                </div>
                
                <div class="modal-body">
                    <p>To enroll in <b>@(CurrentSubject?.SubjectName)</b>, enter the registration code.</p>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Registration Code</label>
                        @* ------------------- Input Field (ID ADDED) ------------------- *@
                        <InputText id="registration-code-input" class="form-control" @bind-Value="EnrollmentDto.RegistrationCode" />
                        <ValidationMessage For="@(() => EnrollmentDto.RegistrationCode)" />
                    </div>

                    @if (!string.IsNullOrEmpty(EnrollmentMessage))
                    {
                        @* ------------------- Enrollment Message (ID ADDED) ------------------- *@
                        <div id="enrollment-message-status" class="alert @(EnrollmentSuccess ? "alert-success" : "alert-danger")">
                            @EnrollmentMessage
                        </div>
                    }
                </div>
                
                <div class="modal-footer">
                    @* ------------------- Cancel Button (ID ADDED) ------------------- *@
                    <button id="enroll-modal-cancel-btn" class="btn btn-secondary" type="button" @onclick="HideEnrollmentModal">Cancel</button>
                    @* ------------------- Submit Button (ID ADDED) ------------------- *@
                    <button id="enroll-modal-confirm-btn" class="btn btn-primary" type="submit" disabled="@IsEnrolling">
                        @if (IsEnrolling)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                        }
                        Confirm Enroll
                    </button>
                </div>
            </EditForm>
        </div>
    </div>
</div>


@code {
    // --- Cascading State and View Selection ---
    
    [CascadingParameter]
    public StudentLayout.StudentLayoutContext? LayoutContext { get; set; }

    // Use the default view from the LayoutContext (which is now Notifications)
    private ViewState SelectedView { get; set; } = ViewState.NotificationsFeed; 

    // --- Data State ---
    
    private List<StudentCourseDto>? EnrolledCourses;
    private List<SubjectDTO>? AvailableSubjects;
    private List<NotificationDto>? Notifications; // <-- NEW

    private string? LoadingError;
    private bool IsLoadingMyCourses = true;
    private bool IsLoadingAllSubjects = true;
    private bool IsLoadingNotifications = true; // <-- NEW

    // --- Modal State ---
    
    private bool ShowEnrollModal = false;
    private SubjectDTO? CurrentSubject;
    private EnrollmentRequestDto EnrollmentDto = new EnrollmentRequestDto();
    private bool IsEnrolling = false;
    private string? EnrollmentMessage;
    private bool EnrollmentSuccess = false;

    // --- Lifecycle and Initialization ---

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && LayoutContext != null)
        {
            // Register the page's callback method with the layout's context.
            LayoutContext.ViewSelectedCallback = SelectView;
            
            // Set initial selected view from the context (now Notifications)
            SelectedView = LayoutContext.SelectedView; 
            
            await LoadDataAsync();
            StateHasChanged();
        }
    }

    private void SelectView(ViewState view)
    {
        SelectedView = view;
        StateHasChanged(); // Force the page to re-render, switching the view content
    }

    // --- Data Loading Logic ---

    public async Task LoadDataAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (!user.Identity?.IsAuthenticated ?? false)
        {
            NavigationManager.NavigateTo("/", true, replace: true);
            return;
        }

        if (!user.IsInRole("Student"))
        {
            NavigationManager.NavigateTo("/forbidden", true, replace: true);
            return;
        }
        LoadingError = null;
        // Run all three data loading tasks concurrently
        await Task.WhenAll(
            LoadMyCoursesAsync(), 
            LoadAllSubjectsAsync(), 
            LoadNotificationsAsync() // <-- NEW: Load Notifications
        );
    }

    private async Task LoadNotificationsAsync() // <-- NEW
    {
        IsLoadingNotifications = true;
        try { 
            Notifications = await NotificationService.GetNotificationFeedAsync(); 
        }
        catch (Exception ex) 
        { 
            // Only set a general error if it's the first error encountered
            if (LoadingError == null) 
            {
                LoadingError = "Failed to load notifications: " + ex.Message;
            }
        }
        finally { IsLoadingNotifications = false; }
    }

    private async Task LoadMyCoursesAsync()
    {
        IsLoadingMyCourses = true;
        try { EnrolledCourses = await EnrollmentService.GetStudentEnrollmentsAsync(); }
        catch (Exception ex) 
        { 
            if (LoadingError == null)
            {
                LoadingError = "Failed to load enrolled courses: " + ex.Message;
            }
        }
        finally { IsLoadingMyCourses = false; }
    }

    private async Task LoadAllSubjectsAsync()
    {
        IsLoadingAllSubjects = true;
        try { AvailableSubjects = await SubjectService.GetAllSubjectsAsync(); }
        catch (Exception ex) 
        { 
             if (LoadingError == null)
            {
                LoadingError = "Failed to load available subjects: " + ex.Message;
            }
        }
        finally { IsLoadingAllSubjects = false; }
    }

    // --- Enrollment Modal Logic ---

    private void ShowEnrollmentModal(SubjectDTO subject)
    {
        CurrentSubject = subject;
        EnrollmentDto = new EnrollmentRequestDto { SubjectId = subject.Id };
        EnrollmentMessage = null;
        EnrollmentSuccess = false;
        ShowEnrollModal = true;
    }

    private void HideEnrollmentModal()
    {
        ShowEnrollModal = false;
        EnrollmentMessage = null;
    }

    private async Task HandleEnrollment()
    {
        try
        {
            IsEnrolling = true;
            EnrollmentMessage = null;
            
            // Assume EnrollAsync returns a DTO or object with EnrollmentId
            var result = await EnrollmentService.EnrollAsync(EnrollmentDto);

            // Success: Update local state immediately for the 'My Courses' view
            EnrolledCourses ??= new();
            EnrolledCourses.Add(new StudentCourseDto
            {
                SubjectId = CurrentSubject!.Id,
                CourseTitle = CurrentSubject.SubjectName,
                EnrollmentId = result.EnrollmentId // Use the ID from the result
            });
            
            EnrollmentMessage = $"Successfully enrolled in {CurrentSubject.SubjectName}!";
            EnrollmentSuccess = true;

            // Wait a moment before closing the modal
            await Task.Delay(1200);
            HideEnrollmentModal();
        }
        catch (Exception ex)
        {
            // Failure Path
            EnrollmentSuccess = false;
            EnrollmentMessage = $"Enrollment failed: {ex.Message}";
        }
        finally
        {
            IsEnrolling = false;
        }
    }

    // --- Drop Course Logic ---

    private async Task ConfirmDropCourse(StudentCourseDto c)
    {
        if (await JSRuntime.InvokeAsync<bool>("confirm", $"Are you sure you want to drop the course: {c.CourseTitle}?"))
            await DropCourseAsync(c);
    }

    private async Task DropCourseAsync(StudentCourseDto c)
    {
        try
        {
            await EnrollmentService.DropCourseAsync(c.EnrollmentId);
            
            // Update local state for the 'My Courses' view
            EnrolledCourses?.Remove(c);
            
            await JSRuntime.InvokeVoidAsync("alert", $"Successfully dropped {c.CourseTitle}.");
            StateHasChanged(); // Refresh the MyCourses view
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("alert", $"Error dropping course: {ex.Message}");
        }
    }
}